name: Stock Market Digest (08:00 AM)

on:
  schedule:
    # 北京时间 08:00 = UTC 00:00
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  run-digest:
    # 必须使用 ubuntu-22.04 以确保 WARP 安装脚本兼容
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    # 缓存 Whisper Medium 模型
    - name: Cache Whisper Model
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-whisper-medium-v1
        restore-keys: |
          ${{ runner.os }}-whisper-medium-

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        # 关键：必须强制安装最新版 yt-dlp
        pip install --upgrade yt-dlp
        pip install -r requirements.txt

    # --- 核心魔法：手动安装 WARP 并开启 SOCKS5 代理模式 ---
    - name: Install and Configure Cloudflare WARP
      run: |
        # 1. 添加 Cloudflare 官方源 GPG Key
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        # 2. 添加源
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
        
        # 3. 安装 WARP
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
        
        # 4. 配置 WARP (Proxy 模式)
        echo "Registering..."
        sudo warp-cli --accept-tos registration new
        
        echo "Setting mode to proxy..."
        sudo warp-cli --accept-tos mode proxy
        
        echo "Setting port to 40000..."
        sudo warp-cli --accept-tos proxy port 40000
        
        echo "Connecting..."
        sudo warp-cli --accept-tos connect
        
        # 5. 智能等待连接 (最多等待 30 秒)
        echo "Waiting for connection to be established..."
        for i in {1..10}; do
          # 检查 WARP 状态
          STATUS=$(sudo warp-cli --accept-tos status)
          echo "Attempt $i: WARP Status: $STATUS"
        
          # 尝试通过代理访问 Google，如果成功则跳出循环
          if curl -x "socks5://127.0.0.1:40000" -s --connect-timeout 3 -I https://www.google.com | grep "200 OK"; then
            echo "✅ WARP 代理连接成功！"
            echo "SUCCESS=true" >> $GITHUB_ENV
            break
          fi
        
          sleep 3
        done
        
        # 6. 最终状态汇报 (即使 curl 失败也不阻断流程，yt-dlp 重试机制可能能过)
        sudo warp-cli --accept-tos status
    # -----------------------------------------------------

    - name: Run Stock Digest Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        GITHUB_ACTIONS: "true"
        # 将本地 WARP 代理地址传给 Python 脚本
        PROXY_URL: "socks5://127.0.0.1:40000"
      # 传入 stock 参数
      run: python main.py stock