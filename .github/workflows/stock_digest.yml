name: Stock Market Digest (08:00 AM)

on:
  schedule:
    # 北京时间 08:00 = UTC 00:00
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  run-digest:
    # 必须使用 ubuntu-22.04 以确保 WARP 安装脚本兼容
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    # 缓存 Whisper Medium 模型
    - name: Cache Whisper Model
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-whisper-medium-v1
        restore-keys: |
          ${{ runner.os }}-whisper-medium-

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade "https://github.com/yt-dlp/yt-dlp/archive/master.zip"
        pip install -r requirements.txt


    - name: Setup and Run V2Ray
      # 1. 关键步骤：先将 Secret 映射为环境变量
      # 这样可以防止 Shell 直接解析 Secret 内容导致引号丢失
      env:
        V2RAY_JSON: ${{ secrets.V2RAY_CONFIG }}
      run: |
        # 下载 V2Ray 核心
        echo "下载 V2Ray..."
        wget -q https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip
        unzip -q v2ray-linux-64.zip -d v2ray-bin
        chmod +x v2ray-bin/v2ray
        
        # 2. 写入配置文件 (使用环境变量)
        # 注意："$V2RAY_JSON" 必须加双引号，这样能保留 JSON 原文中的引号和换行
        echo "$V2RAY_JSON" > v2ray-bin/config.json
        
        # (可选) 调试：打印一下文件前5行，确认格式是否正确 (敏感信息会被 GitHub 自动打码)
        echo "检查配置文件头部..."
        head -n 5 v2ray-bin/config.json
        
        # 3. 后台启动 V2Ray
        echo "启动 V2Ray..."
        ./v2ray-bin/v2ray run -c v2ray-bin/config.json &
        
        # 4. 等待启动并测试
        echo "等待代理就绪..."
        sleep 5
        
        # 测试代理是否通了 (你的配置里 http 端口是 10809)
        # 访问 google 检查返回状态
        if curl -x "http://127.0.0.1:10809" -s -I https://www.google.com | grep "200 OK"; then
           echo "✅ V2Ray 代理启动成功！"
        else
           echo "❌ V2Ray 代理启动失败，请检查配置或节点连通性"
           # 打印一下 V2Ray 的运行日志以便排查
           echo "=== V2Ray 运行日志 ==="
           # 如果 v2ray 刚启动这就退出了，可能没日志，但试一下
           cat v2ray-bin/access.log || true
           cat v2ray-bin/error.log || true
           exit 1
        fi
    # -----------------------------------------------------

    - name: Run Stock Digest Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        GITHUB_ACTIONS: "true"
        # 将本地 WARP 代理地址传给 Python 脚本
        PROXY_URL: "socks5://127.0.0.1:10808"
      # 传入 stock 参数
      run: python main.py stock