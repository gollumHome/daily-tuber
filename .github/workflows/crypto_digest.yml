name: Crypto Market Digest (05:30 PM)

on:
  schedule:
    # 北京时间 17:30 = UTC 09:30
    - cron: '30 9 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  run-digest:
    # 必须使用 ubuntu-22.04
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

    # 缓存 Whisper Medium 模型
    - name: Cache Whisper Model
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-whisper-medium-v1
        restore-keys: |
          ${{ runner.os }}-whisper-medium-

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        # 关键：必须强制安装最新版 yt-dlp
        pip install --upgrade yt-dlp
        pip install -r requirements.txt

    # --- 核心魔法：手动安装 WARP 并开启 SOCKS5 代理模式 ---
    - name: Install and Configure Cloudflare WARP
      run: |
        # 1. 添加 Cloudflare 官方源
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
        
        # 2. 安装 WARP
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
        
        # 3. 配置 WARP (Proxy 模式)
        echo "Configuring WARP..."
        sudo warp-cli --accept-tos registration new
        sudo warp-cli --accept-tos mode proxy
        sudo warp-cli --accept-tos proxy port 40000
        sudo warp-cli --accept-tos connect
        
        # 4. 循环检查连接 (最多等待 30 秒)
        echo "Waiting for connection..."
        CONNECTED=false
        
        for i in {1..10}; do
          # 检查 WARP 状态用于调试
          STATUS=$(sudo warp-cli --accept-tos status)
          echo "Attempt $i: $STATUS"
        
          # 测试代理连接
          if curl -x "socks5://127.0.0.1:40000" -s --connect-timeout 3 -I https://www.google.com | grep "200 OK"; then
            echo "✅ WARP 代理连接成功！"
            CONNECTED=true
            break
          fi
        
          sleep 3
        done
        
        # 5. 严格判断：如果循环结束后仍未连接，直接报错退出
        if [ "$CONNECTED" = "false" ]; then
          echo "❌ 严重错误: WARP 代理无法建立连接，终止任务。"
          # 打印一下最终状态以便排查
          sudo warp-cli --accept-tos status
          # exit 1 会通知 GitHub Actions 这一步失败，后续步骤（Run Python）将不会执行
          exit 1
        fi
    # -----------------------------------------------------

    - name: Run Crypto Digest Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        GITHUB_ACTIONS: "true"
        # 将本地 WARP 代理地址传给 Python 脚本
        PROXY_URL: "socks5://127.0.0.1:40000"
      # 传入 crypto 参数
      run: python main.py crypto