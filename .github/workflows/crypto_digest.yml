name: Crypto Market Digest (05:30 PM)

on:
  schedule:
    # 北京时间 17:30 = UTC 09:30
    - cron: '30 9 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  run-digest:
    # 必须使用 ubuntu-22.04
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

    # 缓存 Whisper Medium 模型
    - name: Cache Whisper Model
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-whisper-medium-v1
        restore-keys: |
          ${{ runner.os }}-whisper-medium-

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade "https://github.com/yt-dlp/yt-dlp/archive/master.zip"
        pip install -r requirements.txt

    - name: Setup and Run V2Ray
      run: |
        # 1. 下载 V2Ray 核心 (Linux 64位)
        echo "下载 V2Ray..."
        wget -q https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip
        unzip -q v2ray-linux-64.zip -d v2ray-bin
        chmod +x v2ray-bin/v2ray
        
        # 2. 写入配置文件 (从 Secret 读取)
        # 将 secret 的内容写入 v2ray-bin 目录下的 config.json
        echo "${{ secrets.V2RAY_CONFIG }}" > v2ray-bin/config.json
        
        # 3. 后台启动 V2Ray
        echo "启动 V2Ray..."
        # 运行在后台
        ./v2ray-bin/v2ray run -c v2ray-bin/config.json &
        
        # 4. 等待启动并测试
        echo "等待代理就绪..."
        sleep 5
        
        # 测试代理是否通了 (你的配置里 http 端口是 10809)
        # 访问 google 检查返回状态
        if curl -x "http://127.0.0.1:10809" -s -I https://www.google.com | grep "200 OK"; then
           echo "✅ V2Ray 代理启动成功！"
        else
           echo "❌ V2Ray 代理启动失败，请检查配置或节点连通性"
           exit 1
        fi
    # -----------------------------------------------------

    - name: Run Crypto Digest Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        GITHUB_ACTIONS: "true"
        # 将本地 WARP 代理地址传给 Python 脚本
        PROXY_URL: "socks5://127.0.0.1:10808"
      # 传入 crypto 参数
      run: python main.py crypto