name: Crypto Market Digest (05:30 PM)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 17:30 = UTC 09:30
    - cron: '30 9 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  run-digest:
    # å¿…é¡»ä½¿ç”¨ ubuntu-22.04
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

    # ç¼“å­˜ Whisper Medium æ¨¡å‹
    - name: Cache Whisper Model
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-whisper-medium-v1
        restore-keys: |
          ${{ runner.os }}-whisper-medium-

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade "https://github.com/yt-dlp/yt-dlp/archive/master.zip"
        pip install -r requirements.txt

    - name: Setup and Run V2Ray
      env:
        V2RAY_JSON: ${{ secrets.V2RAY_CONFIG }}
      run: |
        # 1. ä¸‹è½½ V2Ray
        echo "ä¸‹è½½ V2Ray..."
        wget -q https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip
        unzip -q v2ray-linux-64.zip -d v2ray-bin
        chmod +x v2ray-bin/v2ray

        # 2. å†™å…¥é…ç½®
        echo "$V2RAY_JSON" > v2ray-bin/config.json

        # 3. å¯åŠ¨ V2Ray (åå°è¿è¡Œ)
        echo "å¯åŠ¨ V2Ray..."
        ./v2ray-bin/v2ray run -c v2ray-bin/config.json &

        # 4. ç­‰å¾…å†·å¯åŠ¨
        echo "ç­‰å¾…è¿›ç¨‹å¯åŠ¨ (5s)..."
        sleep 5

        # 5. å¾ªç¯æµ‹è¯•ä»£ç†è¿é€šæ€§ (æœ€å¤šé‡è¯• 5 æ¬¡)
        echo "æ­£åœ¨æµ‹è¯•èŠ‚ç‚¹è¿é€šæ€§..."
        PROXY_READY="false"

        for i in {1..5}; do
          echo "--- ç¬¬ $i æ¬¡å°è¯• ---"
          # -m 5: å•æ¬¡è¯·æ±‚è¶…æ—¶æ—¶é—´ 5ç§’
          # æµ‹è¯• Cloudflare æ¥å£ï¼Œåªè¦è¿”å› ip= å°±è¯´æ˜é€šäº†
          if curl -x "http://127.0.0.1:10809" -s -m 5 https://www.cloudflare.com/cdn-cgi/trace | grep "ip="; then
             echo "âœ… ç¬¬ $i æ¬¡å°è¯•æˆåŠŸï¼V2Ray èŠ‚ç‚¹å·²é€šï¼"
             PROXY_READY="true"
             break
          else
             echo "âš ï¸ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œç­‰å¾… 3 ç§’åé‡è¯•..."
             sleep 3
          fi
        done

        # 6. æœ€ç»ˆåˆ¤æ–­
        if [ "$PROXY_READY" = "false" ]; then
           echo "âŒ ä¸¥é‡é”™è¯¯: å°è¯•äº† 5 æ¬¡ï¼Œä»£ç†ä¾ç„¶æ— æ³•è¿é€šã€‚"
           echo "è¯·æ£€æŸ¥ä½ çš„èŠ‚ç‚¹æ˜¯å¦å¯ç”¨ï¼Œæˆ–è€…é…ç½®å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚"
        fi

        echo "ğŸ‰ ä»£ç†æ£€æµ‹é€šè¿‡ï¼Œå‡†å¤‡è¿è¡Œè„šæœ¬..."
    # -----------------------------------------------------


    - name: Create Cookies File
      run: |
        # ä» Secret è¯»å– Cookie å¹¶å†™å…¥æ–‡ä»¶
        echo "${{ secrets.YOUTUBE_COOKIES }}" > cookies.txt

    - name: Run Crypto Digest Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        GITHUB_ACTIONS: "true"
        # å°†æœ¬åœ° WARP ä»£ç†åœ°å€ä¼ ç»™ Python è„šæœ¬
        PROXY_URL: "http://127.0.0.1:10809"
      # ä¼ å…¥ crypto å‚æ•°
      run: python main.py crypto