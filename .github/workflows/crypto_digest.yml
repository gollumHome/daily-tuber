name: Crypto Market Digest (05:30 PM)

on:
  schedule:
    # 北京时间 17:30 = UTC 09:30
    - cron: '30 9 * * *'
  workflow_dispatch:

jobs:
  run-digest:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

    # 调整为 base 模型缓存，匹配你的 Python 代码
    - name: Cache Whisper Model
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-whisper-base-v1
        restore-keys: |
          ${{ runner.os }}-whisper-base-

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        # 不再需要专门安装 yt-dlp，减少安装耗时
        pip install -r requirements.txt

    - name: Setup and Run V2Ray
      env:
        V2RAY_JSON: ${{ secrets.V2RAY_CONFIG }}
      run: |
        echo "下载 V2Ray..."
        wget -q https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip
        unzip -q v2ray-linux-64.zip -d v2ray-bin
        chmod +x v2ray-bin/v2ray
        echo "$V2RAY_JSON" > v2ray-bin/config.json
        ./v2ray-bin/v2ray run -c v2ray-bin/config.json &
        sleep 5
        
        # 连通性测试
        PROXY_READY="false"
        for i in {1..5}; do
          if curl -x "http://127.0.0.1:10809" -s -m 5 https://www.google.com | grep -q "google"; then
             echo "✅ V2Ray 节点已通！"
             PROXY_READY="true"
             break
          fi
          sleep 3
        done

        if [ "$PROXY_READY" = "false" ]; then
           echo "❌ 代理无法连通，脚本可能在获取 RSS 时失败。"
           exit 1
        fi

    - name: Run Crypto Digest Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
        # 记得在 GitHub Secrets 中添加这个 Key
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        GITHUB_ACTIONS: "true"
        PROXY_URL: "http://127.0.0.1:10809"
      run: python main.py crypto